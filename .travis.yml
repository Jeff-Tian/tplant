language: node_js
node_js:
- node
- lts/*
before_script:
- REPO_VERSION="$(npx -c 'echo "$npm_package_version"')"
- echo "REPO_VERSION=$REPO_VERSION"
- npm run build
- TPLANT_VERSION="$(node dist/index.js -V)"
- echo "TPLANT_VERSION=$TPLANT_VERSION"
- NPM_PACKAGE_VERSION="$(npm view @jeff-tian/tplant version)" || NPM_PACKAGE_VERSION=0
- echo "NPM_PACKAGE_VERSION=$NPM_PACKAGE_VERSION"
- echo "TRAVIS_PULL_REQUEST=$TRAVIS_PULL_REQUEST"
- echo "TRAVIS_BRANCH=$TRAVIS_BRANCH"
- |
  if [ "$REPO_VERSION" != "$TPLANT_VERSION" ]; then
    echo -e '\033[0;31mPackage version and commander version must be the same.';
    travis_terminate 1;
  fi
- |
  if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_BRANCH" == "fork" ] && [ "$REPO_VERSION" == "$NPM_PACKAGE_VERSION" ]; then
    echo -e '\033[0;31mPackage version must be higher than the current one.';
    travis_terminate 1;
  fi
- npm run lint
jobs:
  include:
  - stage: Github Deployment
    node_js: lts/*
    install: skip
    before_script: skip
    script: skip
    before_deploy:
    - REPO_VERSION="$(npx -c 'echo "$npm_package_version"')"
    - echo "REPO_VERSION=$REPO_VERSION"
    - git tag -f "$REPO_VERSION"
    - echo "New Tag $(git describe --tags)";
    deploy:
      provider: releases
      api_key: "$GITHUB_TOKEN"
      on:
        branch: fork
  - stage: npm Deployment
    if: tag IS present
    node_js: lts/*
    before_script: skip
    script: skip
    deploy:
      provider: npm
      email: jeff.tian@outlook.com
      api_key: lqkVeAG0eLaZihcXT/HpzPPUNSWF2nqrjyYo2ux/Djgqad3kHD2dABJWZCDzB0EuxeHZb5PYXyVVdCk3mudY2CR9YvNB881UqbTGsL+BAgAKhZu81vxE037AJL0GBAWx6YXNP0WlNl79n9Ol9Y83oNoNgmFKZeSoO+RdPQpvxoAOhrInEh4XO8X0ROaubegEf3nMr/5zItEo6uPLPITEMH4dZgBSc0ep/zbldJeKL5LnwaLGTOUQjVWWUs83lqQS+rdK0L7U70SUt4Cuqt+EFtbtz4XGHccHOswgShlWWMDRzAlLkKWlZtN8vCBoOgsEKN3dVhxlhWyvHCYviN8Ve8AqWdvhLjdLo85DNVhWLel3Jzw3fi4rYhlXmQA7fzF/WDqAjMnUJy7Nl9maSWUAmvZAgyz9Q/+yr3aitz4AsO73kx/jP3es6b0nEtuN7DT/t1Ib/e0VpzCw+EKIHvsog14KvjjG/c8WzQvb1pBga73WUc1bz4WpGCMJ6TYt7OpCnvVuj7ew1D1QCfcpcDC0opJrjt8BRrNdqjSFFwdhx1f5Bq4Xx3xfXK3PC4Oo31Q1tB55M1spBlV3hJMq/b1NNKSEX5J3ntx3Ga1ABhErDDXA4H4c7efN7rnUptDDFO4qq12Cg9rG5ovBHvsQ+I8xfNTvzzTzYi/L1a57HhVZy5Q=
      skip_cleanup: true
      on:
        tags: true
        branch: fork
