language: node_js
node_js:
- node
- lts/*
before_script:
- REPO_VERSION="$(npx -c 'echo "$npm_package_version"')"
- echo "REPO_VERSION=$REPO_VERSION"
- npm run build
- TPLANT_VERSION="$(node dist/index.js -V)"
- echo "TPLANT_VERSION=$TPLANT_VERSION"
- NPM_PACKAGE_VERSION="$(npm view @jeff-tian/tplant version)" || NPM_PACKAGE_VERSION=0
- echo "NPM_PACKAGE_VERSION=$NPM_PACKAGE_VERSION"
- echo "TRAVIS_PULL_REQUEST=$TRAVIS_PULL_REQUEST"
- echo "TRAVIS_BRANCH=$TRAVIS_BRANCH"
- |
  if [ "$REPO_VERSION" != "$TPLANT_VERSION" ]; then
    echo -e '\033[0;31mPackage version and commander version must be the same.';
    travis_terminate 1;
  fi
- |
  if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_BRANCH" == "fork" ] && [ "$REPO_VERSION" == "$NPM_PACKAGE_VERSION" ]; then
    echo -e '\033[0;31mPackage version must be higher than the current one.';
    travis_terminate 1;
  fi
- npm run lint
jobs:
  include:
  - stage: Github Deployment
    node_js: lts/*
    install: skip
    before_script: skip
    script: skip
    before_deploy:
    - REPO_VERSION="$(npx -c 'echo "$npm_package_version"')"
    - echo "REPO_VERSION=$REPO_VERSION"
    - git tag -f "$REPO_VERSION"
    - echo "New Tag $(git describe --tags)";
    deploy:
      provider: releases
      api_key: "$GITHUB_TOKEN"
      on:
        branch: fork
  - stage: npm Deployment
    if: tag IS present
    node_js: lts/*
    before_script: skip
    script: skip
    deploy:
      provider: npm
      email: jeff.tian@outlook.com
      api_key:
        secure: NIFuy2bGLkJGi7heM+gLZzEcabgX+cdfiwBrZov0X8BlBkKcr4L2zl1ob3EeUJYrWJBYPYh84XZQY6imBDqeo1aFsat9Ob/iUDtlthSXw8S02lZyFWG66wtWQ6n3MGu+/UquLCe1rwOfdfJwkmVudaiorriNLz0D9gl6aldqSuSuwE97B4oaArHsRhYwGL+9tdc5AoL/aOMgQG0+pHLPMPEcd1dgu5ReJyE3XB02VJYeZAB7yGv+J3fLcNjmg/eLpVcoReIMTSFiXSsLZJrB3Q6K043Fy6j8xr+xhpx/pRvgIExxFSJixGClY1dBtnqOnYFjASHgTtcpfvWzSsb8s5FkxDIde6v/BdpBv8i+IXIKX28vuhT/ktnzgb69Z9MmPNloeKWwEekeNHPuNaFeAm6UpSmhPytly6Zg44tHryJSKe7uUP53xI8xu/kPvCFBTHglz2bo2oNMM20b89wxZbnO5SvBcFmMOc9QT2nkvSlWF6Z4wDSrXoUs0XwpBru2N9cmY+nHqM3tPwXbr2fCypp20YER8X3qz5K7jsvLBm6R7MIcnl5MLMdWApTzVrwb/r0NgGlpPTvWmi8O/lfiAL1Nswpda9Z+6bY+yKC+GKv1nCPdOcRpSC2pbPJWdDfrYyhbp3xu5pF1V4zgamXQcv0JuakiFHCIZzPqvdJ+2w4=
      skip_cleanup: true
      on:
        tags: true
        branch: fork
deploy:
  provider: npm
  email: jeff.tian@outlook.com
  api_key:
    secure: ix1YuBw9yjRCqOLMyUbLO/k+N0EWUGD6rhsNn9wgxVag1LyQ9og3r0feZh9lQc1VvQz2VLonwBEthPH7MJiuLMnkzHosRySPpL1XIWjE0oZRtWpjfk6ejzKznUgNelZU9jKJ9InHqnYID0xYnYo6iAPPJyp8OZm+K0k7Ky3K7ZfeN+PxG8F8lb6/+nmQHK9t5pMqXKt4tNkpoFCUdHIQUVxeDzrXfdZEBiLRQstbpvcI1w/uLIl1eXX1rFEcolGiUaKCnc1CJrhzMAnjhWH6XP7eCwM8astHlrwoEVXmvUjI39pvcDRFBDHqIcaq5O+7oQce5S+zXzcaXwKrdKkNWsMIzJslp5ROfYr6fbRaCKKfvGpeoYQ6ypIKEmCGrrj7d5ydN2k8KL9mZsd7Vyl0hu2lxZiXbiQkghgu1D8Tjddw3vLjQ+BrWtBbCGFqtXtwei1GTUSdNzPKLodpxJ1AqJ8xtNoVlyORU51yqDXVp7lt7lW++ytJlYokkITRWUgJ0+AhBuTfxbjpmv4pIDMenZ7O1NkGF5aniJ38LeMd3X8teq+BD9yWiUlNs/gi6J64sIsXq8vzaLt4fplj468euNiP8yZPmEh4Vl/eKggZ9ELY/ujYBqglwkZKgRkoSOz0G+JiLN9ji38qG8+wynaYUnm6qJdFNPwGyf4Jmrr6wjc=
  on:
    tags: true
    repo: Jeff-Tian/tplant
    branch: fork
