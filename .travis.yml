language: node_js
node_js:
- node
- lts/*
before_script:
- REPO_VERSION="$(npx -c 'echo "$npm_package_version"')"
- echo "REPO_VERSION=$REPO_VERSION"
- npm run build
- TPLANT_VERSION="$(node dist/index.js -V)"
- echo "TPLANT_VERSION=$TPLANT_VERSION"
- NPM_PACKAGE_VERSION="$(npm view @jeff-tian/tplant version)" || NPM_PACKAGE_VERSION=0
- echo "NPM_PACKAGE_VERSION=$NPM_PACKAGE_VERSION"
- echo "TRAVIS_PULL_REQUEST=$TRAVIS_PULL_REQUEST"
- echo "TRAVIS_BRANCH=$TRAVIS_BRANCH"
- |
  if [ "$REPO_VERSION" != "$TPLANT_VERSION" ]; then
    echo -e '\033[0;31mPackage version and commander version must be the same.';
    travis_terminate 1;
  fi
- |
  if [ "$TRAVIS_PULL_REQUEST" != "false" ] && [ "$TRAVIS_BRANCH" == "fork" ] && [ "$REPO_VERSION" == "$NPM_PACKAGE_VERSION" ]; then
    echo -e '\033[0;31mPackage version must be higher than the current one.';
    travis_terminate 1;
  fi
- npm run lint
jobs:
  include:
  - stage: Github Deployment
    node_js: lts/*
    install: skip
    before_script: skip
    script: skip
    before_deploy:
    - REPO_VERSION="$(npx -c 'echo "$npm_package_version"')"
    - echo "REPO_VERSION=$REPO_VERSION"
    - git tag -f "$REPO_VERSION"
    - echo "New Tag $(git describe --tags)";
    deploy:
      provider: releases
      api_key: "$GITHUB_TOKEN"
      on:
        branch: fork
  - stage: npm Deployment
    if: tag IS present
    node_js: lts/*
    before_script: skip
    script: skip
    deploy:
      provider: npm
      email: jeff.tian@outlook.com
      api_key:
        secure: Xvczkfs9NSnySEf41klaby5gl17/UoxNMtTry5+I9DTKu5EY8/mVP1YRw7D5q/GcAtDUpwGALoIKcMV7LZL7i+IrDisSq0GXCtxcO7hwKgM+bPM6Gs38w4YoI4n3PMvERh16gRuhCYP8gWZnKU1E0Kqk8DKFsfikjRtw921T8nmYfZNgon+FAteXgJeLs1GZso+Tm4Qx2pm4zZ4AFlBI/7fNwqFY/I1rN5tkn+/UzFtGCZjGMGKXDEXnDAs/NvRe4fnHJJYa8uJxEyXl3GcWoX6YY8bZUMVB350hbaYVYfe4ktDMAa89PTbrgTBUUtFoSInAyQLd5TZWkm8HhvHu9BnuCi71x1ePq/xhmmG9SY7fbh8vDQ5n5HCBMdy9V1RnUtHHJFLYNv6L0tcxCkafKQNNR5zblnEFAr29JyKBXZ/+SEX/WTl/Ywq04B4LnAeZbv9FgsHa9KWmKfD90AE5bn4dmmTFhOngfT3XqUCLZP6ElhEhTGeZHO16pcKsAYyhIZq0bKwTDlMjXbqTwUrxiTxDJDTkYIWRWBG37YVAhYWLDdmY+Jo9CCPSyT0q7wcfftDzKj1CjOx8BbRAxZrCxDePfY3KKN4yxcwnLaZsmbX8gvNOQIR4KBDQG+BzmSdz4LJt1qKlOY34NWX3OzY4aYGqR0eZ+PsYh3heFRl7W7E=
      skip_cleanup: true
      on:
        tags: true
        branch: fork
